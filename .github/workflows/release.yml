name: Publish Release

on:
  push:
    tags:
      - v* # triggers on version tags like v1.0.0
  workflow_dispatch:
    inputs:
      version:
        description: Fake version (for dry-run testing)
        required: false
        default: v0.0.0-test

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install hatch
          pip install pyyaml

      - name: Set version variable
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_ENV
          else
            echo "VERSION=${GITHUB_REF_NAME}" >> $GITHUB_ENV
          fi

      - name: Determine prerelease and dry-run
        id: prerelease
        run: |
          # prerelease detection
          if [[ "${VERSION}" =~ (alpha|beta|rc|test|-test) ]]; then
            echo "prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "prerelease=false" >> $GITHUB_OUTPUT
          fi

          # dry-run detection
          if [[ "${VERSION}" == "v0.0.0-test" ]]; then
            echo "dryrun=true" >> $GITHUB_OUTPUT
          else
            echo "dryrun=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate Hugo release notes + API
        run: python scripts/generate_releases.py

      - name: Prepare GitHub release notes
        run: python scripts/prepare_release_notes.py "${VERSION}"

      - name: Update download page with new version
        if: github.event_name != 'workflow_dispatch'
        run: |
          DOWNLOAD_FILE="docs/content/download/_index.en.md"

          # Update the link
          sed -i "s#archive/refs/tags/v.*.zip#archive/refs/tags/v$VERSION.zip#g" "$DOWNLOAD_FILE"

          # Update the visible label
          sed -i "s#Download v.* ZIP#Download v$VERSION ZIP#g" "$DOWNLOAD_FILE"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "$DOWNLOAD_FILE"
          git commit -m "Update download link for $VERSION" || echo "No changes to commit"

      - name: Build with Hatch
        run: hatch build

      - name: Upload release assets with notes
        if: github.event_name != 'workflow_dispatch'
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*
          body_path: RELEASE_NOTES.md
          prerelease: ${{ steps.prerelease.outputs.prerelease }}

      - name: Upload to TestPyPI (pre-release only)
        if: steps.prerelease.outputs.prerelease == 'true' && steps.prerelease.outputs.dryrun == 'false'
        run: |
          echo "Uploading pre-release to TestPyPI..."
          pip install twine
          twine upload --repository testpypi dist/*
        env:
          TWINE_USERNAME: ${{ secrets.TESTPYPI_USERNAME }}
          TWINE_PASSWORD: ${{ secrets.TESTPYPI_PASSWORD }}

      - name: Upload to PyPI (stable only)
        if: steps.prerelease.outputs.prerelease == 'false' && steps.prerelease.outputs.dryrun == 'false'
        run: |
          echo "Uploading stable release to PyPI..."
          pip install twine
          twine upload dist/*
        env:
          TWINE_USERNAME: ${{ secrets.PYPI_USERNAME }}
          TWINE_PASSWORD: ${{ secrets.PYPI_PASSWORD }}
  publish-homebrew:
  name: Publish Homebrew Formula
  needs: build-and-release
  runs-on: ubuntu-latest

  if: |
    github.event_name == 'workflow_dispatch' ||
    (github.event_name != 'workflow_dispatch' &&
    !contains(github.ref_name, 'alpha') &&
    !contains(github.ref_name, 'beta') &&
    !contains(github.ref_name, 'rc') &&
    !contains(github.ref_name, 'test'))

  steps:
    - name: Checkout main repo
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Export VERSION (tag only)
      run: |
        if [[ "$GITHUB_REF_TYPE" != "tag" ]]; then
          echo "ERROR: Homebrew publish must run from a tag" >&2
          exit 1
        fi
        echo "VERSION=${GITHUB_REF_NAME}" >> "$GITHUB_ENV"

    - name: Install Homebrew
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential curl git
        NONINTERACTIVE=1 /bin/bash -c \
          "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
        echo "/home/linuxbrew/.linuxbrew/bin" >> "$GITHUB_PATH"

    - name: Ensure Formula directory
      run: |
        mkdir -p Formula

    - name: Generate Homebrew formula
      run: |
        set -e
        # Retry generation up to 3 times
        for i in 1 2 3; do
          python scripts/generate_brew_formula.py && break
          echo "Attempt $i failed, retrying in 30s..."
          sleep 30
        done

        # Validate that the formula was generated
        if [ ! -f Formula/indexly.rb ]; then
          echo "ERROR: Formula/indexly.rb was not generated!" >&2
          exit 1
        fi

        ruby -c Formula/indexly.rb
        ls -la Formula/

    - name: Checkout Homebrew tap
      uses: actions/checkout@v4
      with:
        repository: kimsgent/homebrew-indexly
        token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        path: homebrew-indexly

    - name: Update formula in tap
      run: |
        mkdir -p homebrew-indexly/Formula
        cp Formula/indexly.rb homebrew-indexly/Formula/indexly.rb
        echo "âœ” Copied freshly generated formula to Homebrew tap"

    - name: Brew audit & style
      run: |
        set -e
        eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
        brew tap kimsgent/indexly
        brew audit --strict indexly
        brew style indexly

    - name: Commit and push formula
      if: github.event_name != 'workflow_dispatch'
      run: |
        set -e
        cd homebrew-indexly
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add Formula/indexly.rb
        git commit -m "chore: update Homebrew formula for ${VERSION}" || exit 0
        git pull --rebase
        git push
